name: Sync to Hugging Face
on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Backup and Push to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # Clone the Hugging Face repository
          git clone https://XE45:$HF_TOKEN@huggingface.co/spaces/XE45/CoreSightGroup hf_repo
          cd hf_repo
          
          # Create Previous folder if it doesn't exist
          mkdir -p Previous
          
          # Get timestamp for backup folder name
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          BACKUP_DIR="Previous/backup_$TIMESTAMP"
          
          # Copy current files to backup (excluding .git and Previous folder)
          mkdir -p "$BACKUP_DIR"
          find . -maxdepth 1 -not -name '.' -not -name '..' -not -name '.git' -not -name 'Previous' -exec cp -r {} "$BACKUP_DIR"/ \;
          
          # Remove old files (except .git and Previous folder)
          find . -maxdepth 1 -not -name '.' -not -name '..' -not -name '.git' -not -name 'Previous' -exec rm -rf {} \;
          
          # Copy new files from GitHub
          cp -r ../!(hf_repo) .
          
          # Commit and push changes
          git add .
          git commit -m "Sync from GitHub - Backup created at $TIMESTAMP" || echo "No changes to commit"
          git push origin main
